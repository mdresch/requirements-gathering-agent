/**
 * Test API Endpoint with Mock Template Fallback
 * 
 * This test verifies that the API endpoint can now generate documents
 * using mock templates when the database is not available.
 */

async function testApiEndpointWithMockTemplates() {
  console.log('🧪 Testing API Endpoint with Mock Template Fallback');
  console.log('==================================================');
  
  try {
    // Test the API endpoint directly
    const testData = {
      context: 'Generate Stakeholder Analysis document for project: Self Charging Electric Vehicle\n\nProject Description: A Self Charging Electric Vehicle energy producing elements onboard an electric vehicle. Arriving home fully charged.\nProject Status: active\nFramework: pmbok\nCompliance Score: 89%',
      documentKeys: ['stakeholder-analysis'],
      generateAll: false,
      projectId: '68d23a873cef04e17b7f1680',
      framework: 'pmbok'
    };
    
    console.log('🚀 Making API call to document generation endpoint...');
    console.log('📋 Request data:', JSON.stringify(testData, null, 2));
    
    const response = await fetch('http://localhost:3001/api/v1/document-generation/generate-only', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(testData)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('❌ API Error:', errorText);
      throw new Error(`API call failed: ${response.statusText} - ${errorText}`);
    }
    
    const result = await response.json();
    console.log('📋 API Response:', JSON.stringify(result, null, 2));
    
    if (result.success && result.generatedDocuments?.length > 0) {
      const document = result.generatedDocuments[0];
      console.log('✅ Document generated successfully:');
      console.log(`   - Title: ${document.title}`);
      console.log(`   - Content Length: ${document.content.length} characters`);
      console.log(`   - Content Preview: ${document.content.substring(0, 500)}...`);
      
      // Check if content looks like it was generated by AI
      if (document.content.includes('Stakeholder Analysis') && 
          document.content.includes('Executive Summary') &&
          document.content.includes('Power/Interest Grid')) {
        console.log('✅ Content appears to be AI-generated with proper structure');
        console.log('✅ Mock template fallback is working');
        console.log('✅ Database-first generation is now functional');
      } else {
        console.log('⚠️ Content may not be properly AI-generated');
        console.log('📋 Full content:');
        console.log(document.content);
      }
    } else {
      console.log('❌ API call failed or no documents generated');
      console.log('📋 Response:', result);
    }
    
  } catch (error) {
    console.error('❌ Test failed:', error);
    console.log('💡 Make sure the server is running on localhost:3001');
  }
}

// Run the test
testApiEndpointWithMockTemplates().catch(console.error);
